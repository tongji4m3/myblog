---
title: 数据库——Redis相关笔记------RDB持久化
author: tongji4m3
top: false
cover: false
coverImg: /images/1.jpg
toc: true
mathjax: false
summary: 学习Redis所做的笔记，此为Redis的RDB持久化，包括持久化过程、间隔性保存等。
categories: Redis
tags:
  - Redis
  - RDB
  - BGSAVE
abbrlink: 35012ee
date: 2020-11-28 00:00:00
---

# RDB文件的创建与载入

## 创建

`SAVE指令`会阻塞Redis服务器进程，直到RDB文件创建完毕为止，在服务器进程阻塞期间，服务器不能处理任何命令请求，所以当Save命令正在执行时，客户端发送的所有命令请求都会被阻塞

`BGSAVE命令`会派生出一个子进程，由它负责创建RDB文件，服务器进程(父进程)继续处理命令请求。



1、在`BGSAVE`命令执行期间，客户端发送的`SAVE`命令会被服务器拒绝。服务器禁止`SAVE`与`BGSAVE`同时执行是为了避免父进程和子进程同时指向两个`rdbSave`调用，防止产生竞争条件。

2、同样的道理，在`BGSAVE`执行期间，客户端的`BGSAVE`命令也会被服务器拒绝。

3、另外，对于AOF持久化命令`BGREWRITEAOF`与`BGSAVE`也同样是互斥关系，如果`BGSAVE`正在执行，则`BGREWRITEAOF`命令会被延迟到`BGSAVE`执行完毕之后；而`BGREWRITEAOF`命令执行时，服务器会拒绝`BGSAVE`命令的执行。

4、而事实上，因为`BGREWRITEAOF`命令与`BGSAVE`两个命令的实际工作都是由子进程执行，所以这两个命令在操作方面并没有冲突的地方，不能同时执行只是性能方面的考虑--并发处两个子进程，并且这两个子进程同时对磁盘进行大量读写。

```python
def SAVE():
	#创建RDB文件
	rdbSave（）
	
def BGSAVE():
	# 创建子进程
	pid=fork()
	
	if pid == 0:
		# 子进程负责创建RDB文件
		rdbSave（）
		# 完成之后向父进程发送信号
		signal_parent()
	elif pid>0:
		# 父进程继续处理命令请求，并通过轮询等待子进程的信号
		handle_request_and_wait_signal()
	else:
		# 处理出错情况
		handle_fork_error()
```

## 载入

- RDB文件的载入工作是服务器启动时自动进行的，只要Redis服务器在启动时检测到RDB文件存在，就会自动载入RDB文件
- 如果服务器开启了AOF持久化功能，则优先使用AOF文件还原数据库状态
- 只有未开启AOF持久化功能，才会使用RDB文件还原数据库状态
- 服务器在载入RDB文件时会一直处于阻塞状态，直到载入工作完成

# 自动间隔性保存

服务器每隔一段时间自动执行一次`BGSAVE`命令，可以设置多个保存条件，只要任意一个条件被满足，服务器就会执行`BGSAVE`指令

```c
save 900 1
save 300 10
save 60 10000

服务器在900秒内进行了至少1次修改
服务器在300秒内进行了至少10次修改
服务器在60秒内进行了至少10000次修改
```

## 设置保存条件

服务器程序根据save选项（可通过配置文件设置）所设置的保存条件，设置服务器状态的redisServer结构的saveparams属性

```c
struct redisServer
{
	struct saveparam * saveparams;
	long long dirty; //距离上一次成功执行BGSAVE之后，进行修改的次数
	time_t lastsave; //上一次成功执行BGSAVE的时间
};

struct saveparam
{
	time_t seconds;
	int changes;
}
```

## 检查保存条件是否满足

服务器周期性操作函数serverCron()默认每隔100ms执行一次

其中一项工作就是检查save选项所设置的保存条件是否已经满足

如果满足，则执行BGSAVE（）

```python
def serverCron():
	# 遍历所有保存条件
	for saveparam in server.saveparams:
		save_interval=unixtime_now() - server.lastsave
		
		#如果数据库状态的修改次数超过条件所设置的次数
		#并且距离上次保存的时间超过条件所设置的时间
		#那么执行保存操作
		if server.dirty >= saveparam.changes and save_interval>saveparam.seconds:
			BGSAVE()
```

# RDB文件结构

## 概览

1. REDIS，通过这五个字符，程序可以在载入文件时，快速检查所载入的文件是否是RDB文件
2. db_version，记录了版本号
3. databases，包含任意个数据库以及他们的键值对数据。
4. EOF，标志着RDB文件正文内容的结束
5. check_sum，校验和，检查RDB文件是否有出错或损坏的情况。服务器在载入RDB文件时，会将载入数据所计算出的校验和与check_sum进行比对，已发行RDB文件是否损坏

## databases

每个非空数据库保存三部分：

1. SELECTDB 常量，说明接下来会读取一个数据库号码
2. db_number，读入后，调用SELECT指令，进行数据库切换，使得之后读入的键值对可以载入到正确的数据库之中
3. key_value_pairs，保存了数据库中的所有键值对数据。包含过期时间。

## key_value_pairs

1. TYPE记录了value的类型，代表了一种对象类型或底层编码。程序根据TYPE的值决定如何读入和解释value的数据
2. key总是一个字符串对象
3. value根据TYPE的指令保存相应类型的内容
4. EXPIRETIME_MS常量，代表之后会读取一个以毫秒为单位的过期时间
5. ms，保存键值对的过期时间，以毫秒为单位的UNIX时间戳

