---
title: 《Redis设计与实现》-------复制
author: tongji4m3
top: false
cover: false
coverImg: /images/1.jpg
toc: true
mathjax: false
summary: '学习《Redis设计与实现》所做的笔记,此为书上第十五章--复制。'
categories: Redis学习笔记
tags:
  - Redis
  - 复制
  - 数据库
abbrlink: 2e019a64
date: 2020-09-26 00:00:00
---

# 简介

被复制的服务器称为主服务器,对主服务器进行复制的服务器称为从服务器

进行复制中的主从服务器双方的数据库将保存相同的数据

# 旧版复制功能的实现

## 同步

用于将从服务器的数据库状态更新至当前所处的数据库状态

## 命令传播

用于在主服务器的数据库状态被修改,导致主从服务器的数据库状态出现不一致时,让主从服务器的数据库重新回到一致状态

## 缺陷

旧版复制功能在处理断线重复制情况时低效

# 新版复制功能的实现

1. 完整重同步:用于处理初次复制的情况,通过让主服务器创建并发送`RDB文件`,以及向从服务器发送保存在缓冲区里面的写命令进行同步
2. 部分重同步:用于处理**断线后重复制**情况,当从服务器在断线后重新连接主服务器时,如果条件允许,主服务器可以将主从服务器断开期间执行的写命令发送给从服务器,从服务器只要接收并执行这些写命令,就可以将数据库更新至主服务器当前所处的状态

# 部分重同步的实现

1. 复制偏移量
2. 复制积压缓冲区
3. 服务器运行ID

# 复制的实现

## 步骤1:设置主服务器的地址和端口

执行:`SLAVEOF 127.0.0.1 6379`

```c
struct redisServer
{
	char * masterhost;//主服务器的地址
	int masterport;//主服务器的端口号
};
```

## 步骤2:建立套接字连接

如果从服务器创建的套接字能成功连接到主服务器,从服务器是主服务器的客户端,以从服务器向主服务器发送命令请求的形式来进行.

## 步骤3:发送PING命令

1. 检查套接字的读写状态是否正常
2. 检查主服务器能否正常处理命令请求

## 步骤4:身份验证

## 步骤5:发送端口信息

## 步骤6:同步

从服务器将向主服务器发送`PSYNC命令`,执行同步操作,并将自己的数据库更新至主服务器数据库当前所处的状态

## 步骤7:命令传播

主服务器只要一直将自己执行的写命令发送给从服务器,而从服务器只要一直接收并执行主服务器发来的写命令,就可以保证主从服务器保持一致了



# 心跳检测

在命令传播阶段,从服务器默认以每秒一次的频率,向主服务器发送从服务器当前的复制偏移量,有三个作用:

## 检测主从服务器的网络连接状态

## 辅助实现min-slaves配置选项

防止主服务器在不安全的情况下执行写命令

## 检测命令丢失

如果命令丢失,主服务器会发觉从服务器当前的复制偏移量少于自己的**复制偏移量**,然后主服务器就会通过从服务器提交的复制偏移量,在复制积压缓冲区里找到从服务器缺少的数据,并将这些数据重新发送给从服务器.