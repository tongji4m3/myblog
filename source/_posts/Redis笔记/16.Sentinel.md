---
title: 《Redis设计与实现》------Sentinel
author: tongji4m3
top: true
cover: false
coverImg: /images/1.jpg
toc: true
mathjax: false
summary: '学习《Redis设计与实现》所做的笔记,此为书上第十六章--Sentinel。'
categories: Redis学习笔记
tags:
  - Redis
  - Sentinel
  - 数据库
abbrlink: b89933c6
date: 2020-09-28 00:00:00
---

# Sentinel简介

`Sentinel`(哨兵)是Redis的高可用性解决方案:由一个或多个`Sentinel`实例组成的Sentinel系统可以监视任意多个主服务器,以及这些主服务器属下的所有从服务器,并在被监视的主服务器进入下线状态时,自动将下线主服务器属下的某个从服务器升级为新的主服务器,然后由新的主服务器代替已下线的主服务器继续处理命令请求。

# 启动并初始化Sentinel

启动`Sentinel`会执行以下操作：

1. 初始化服务器
2. 将普通Redis服务器使用的代码替换成`Sentinel`专用代码
3. 初始化`Sentinel`状态
4. 根据给定的配置文件,初始化`Sentinel`的监视主服务器列表
5. 创建连向主服务器的网络连接

## 初始化Sentinel状态的masters属性

`dict * masters;`保存了所有被这个Sentinel监视的主服务器

`masters`字典键是监视主服务器的名字,值是被监视主服务器对应的`sentinelRedisInstance`结构

每个`sentinelRedisInstance`结构代表了一个被sentinel监视的Redis服务器实例,这个实例可以是主服务器,从服务器或者另外一个`Sentinel`

```c
typedef struct sentinelRedisInstance
{
	int flags;//标识值,记录了实例的类型,以及该实例的当前状态
	
	//实例的名字
	//主服务器的名字由用户在配置文件中设置
	//从服务器以及Sentinel的名字由Sentinel自动设置
	//格式为ip:port,例如"127.0.0.1:26379"
	char * name;
	
	//实例的运行ID
	char * runid;
	
	//配置纪元,用于实现故障转移
	uint64_t config_epoch;
	
	sentinelAddr * addr; //实例的地址
	
	mstime_t down_after_period;//实例无响应多少毫秒后才会被认为是主观下线
	int quorum;//判断这个实例为客观下线所需的支持投票数量
	int parallel_syncs;//在执行故障转移操作时,可以同时对新的主服务器进行同步的从服务器数量
	mstime_t failover_timeout;//刷新故障迁移状态的最大时限
}
```

```c
struct sentinelAddr
{
	char * ip;
	int port;
}
```

## 获取主服务器的信息

`Sentinel`默认会以每10秒一次的频率,通过命令连接向被监视的主服务器发送INFO命令

对于主服务器返回的从服务器信息,会被用于更新主服务器实例结构的`slavers`字典,该字典记录了主服务器属下从服务器的名单

# 获取从服务器信息

当`Sentinel`发现主服务器有新的从服务器出现时,除了会为这个新的从服务器创建相应的实例结构外,还会创建连接到从服务器的命令连接和订阅连接

# 检测主观下线状态

默认情况下,`Sentinel`会以每秒一次的频率向所有与它创建了命令连接的实例(包括主服务器,从服务器,其他`Sentinel`在内)发送PING命令,并通过实例返回的`PING`命令来判断实例是否在线

## 检测客观下线状态

当`Sentinel`将一个主服务器判断为主观下线后,它会向同样监视这一主服务器的其他`Sentinel`进行询问,如果接收到了足够数量的已下线判断之后,`Sentinel`就会将主服务器判断为客观下线,并对主服务器执行故障转移操作