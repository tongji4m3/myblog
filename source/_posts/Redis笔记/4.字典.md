---
title: 《Redis设计与实现》-------字典
author: tongji4m3
top: false
cover: false
coverImg: /images/1.jpg
toc: true
mathjax: false
summary: '学习《Redis设计与实现》所做的笔记,此为书上第四章--字典。'
categories: Redis学习笔记
tags:
  - Redis
  - 数据结构
  - 字典
abbrlink: 4ea31ca4
date: 2020-08-18 00:00:00
---

# 简介

`Redis`的数据库底层就是用字典实现的

字典也是**哈希键**的底层实现之一

# 字典的实现

字典采用哈希表作为底层实现,一个哈希表可以有多个哈希表节点,每个节点保存了一个键值对

每个字典带有**两个哈希表**,一个平时使用,一个仅仅在rehash时使用

## 哈希表

```c
typedef struct dictht
{
	dictEntry ** table;//哈希表数组
	unsigned long size;
	unsigned long sizemask;//哈希表大小掩码,用于计算索引值 总=size-1
	unsigned long used;
}dictht;
```

`sizemask`和哈希值一起决定一个键应该放到table数组里面的哪个索引上

## 哈希表节点

```c
typedef struct dictEntry
{
	void *key;
	union
	{
		void *val;
		uint64_t u64;
		int64_t s64;
	} v;
	struct dictEntry * next; 
}dictEntry;
```

值可以是应该指针,或者是应该uint64_t类型的整数,或是一个int64_t整数

next属性指向另一个哈希表节点的指针,可以将多个哈希值相同的键值对连接在一起,以解决键冲突

## 字典

```c
typedef struct dict
{
	dicType * type;//类型特定函数
	void * privdata;//私有数据
	ditcht ht[2];//哈希表
	
	int rehashidx;//rehash索引,当rehash不再进行时,值为-1
}dict;
```

1. `type`,`privdata`属性是针对不同类型的键值对,为创建多态字典而设置的
2. 每个`dicType`结构保存了一簇用于操作特定类型键值对的函数
3. `privdata`属性保存了需要传给那些类型特定函数的可选参数
4. ht数组中,每个项都是**ditcht哈希表**,一般只使用`ht[0]`,ht[1]只会在ht[0]进行rehash时使用
5. `rehashidx`记录rehash目前的进度

# 哈希算法

程序先通过键计算哈希值hash,在计算索引值(`index=hash & sizemask`),再根据索引将包含新键值对的哈希表节点放到哈希表数组的指定索引上

# 解决键冲突

用链地址法,多个分配到同一个索引的节点用单向链表连接起来。且用头插法，将新节点添加到链表的表头位置 

# rehash

## 时机

1. 若没有在执行`BGSAVE`或`BGREWRITEAOF`命令,则哈希表负载因子>=1时rehash
2. 若在执行BGSAVE或BGREWRITEAOF命令,则哈希表负载因子>=5时rehash
3. `load_factor=ht[0].used / ht[0].size`
4. 以上的不同是因为,执行那两个命令时,Redis需要创建当前服务器进程的**子进程**,在子进程存在期间,服务器会提高执行扩展操作所需的负载因子,从而京可能避免在子进程存在期间进行哈希表的扩展操作,可以避免不必要的内存写入操作,最大限度地节约内存
5. 当负载因子<0.1,则自动进行收缩操作

## 步骤

1. 为字典的ht[1]哈希表分配空间:如果是扩展,则ht[1]大小为第一个>= `ht[0].used*2` 的2^n​。如果是收缩，则是第一个>= `ht[0].used` 的2^n​。
2. 将保存在ht[0]的所有键值对rehash到ht[1]上面，即重新计算哈希值和索引值，然后放到ht[1]的指定位置上
3. 当ht[0]所有的键值对都迁移到了ht[1]，则将ht[1]设置为ht[0]，并且在ht[1]新建一个空哈希表

# 渐进式rehash

1. rehash时，服务器不是一次就将ht[0]里面的所有键值对全部rehash到ht[1]。而是分多次，**渐进式**地将ht[0]里面的键值对慢慢地`rehash`到ht[1]
2. 在执行操作之外，顺带将键值对rehash到ht[1]中，把rehash键值对所需的计算工作均摊到每次对字典的增删改查操作之中
3. 在进行渐进式rehash时，字典**同时**使用ht[0]，ht[1]。所以操作同时在两个哈希表中进行，即如果要查找一个键，会先在ht[0]找，没找到就继续到ht[1]中找
4. 新添加的键值对直接保存到ht[1]中